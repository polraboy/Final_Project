<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>สรุปผลการดำเนินโครงการ</title>
    <link
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #ff8c00;
        --secondary-color: #007bff;
        --background-color: #f8f9fa;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
      }

      body {
        background-color: var(--background-color);
        font-family: "Kanit", sans-serif;
        padding-bottom: 100px;
      }

      .navbar {
        background-color: var(--primary-color) !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .navbar-brand img {
        margin-right: 10px;
      }

      .navbar-brand span {
        font-size: 1rem;
        line-height: 1.2;
        color: white;
      }

      .nav-link {
        color: white !important;
        transition: all 0.3s ease;
      }

      .nav-link:hover {
        transform: translateY(-2px);
      }

      .content-box {
        background-color: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        margin-top: 30px;
        margin-bottom: 50px;
      }

      .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        transition: all 0.3s ease;
      }

      .btn-primary:hover {
        background-color: darken(var(--primary-color), 10%);
        border-color: darken(var(--primary-color), 10%);
        transform: translateY(-2px);
      }

      .mb-4 {
        text-align: center;
        color: var(--primary-color);
        font-weight: bold;
        margin-bottom: 30px !important;
      }

      .section-title {
        border-left: 5px solid var(--primary-color);
        padding-left: 15px;
        margin-bottom: 20px;
        font-weight: bold;
        color: #333;
      }

      .status-badge {
        font-size: 1rem;
        padding: 8px 15px;
        border-radius: 30px;
      }

      .status-excellent {
        background-color: #28a745;
        color: white;
      }

      .status-verygood {
        background-color: #4CAF50;
        color: white;
      }

      .status-good {
        background-color: #8BC34A;
        color: white;
      }

      .status-fair {
        background-color: #FFC107;
        color: #333;
      }

      .status-poor {
        background-color: #FF9800;
        color: white;
      }

      .status-improvement {
        background-color: #F44336;
        color: white;
      }

      .info-card {
        transition: all 0.3s ease;
        border-radius: 10px;
        overflow: hidden;
        height: 100%;
      }

      .info-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }

      .info-card .card-header {
        font-weight: bold;
        color: white;
      }

      .info-card .card-body {
        padding: 20px;
      }

      .info-card.primary .card-header {
        background-color: var(--primary-color);
      }

      .info-card.secondary .card-header {
        background-color: var(--secondary-color);
      }

      .info-card.success .card-header {
        background-color: var(--success-color);
      }

      .info-card.warning .card-header {
        background-color: var(--warning-color);
        color: #333;
      }

      .progress-circle {
        position: relative;
        width: 150px;
        height: 150px;
        margin: 0 auto 20px;
      }

      .progress-circle-bg {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 15px solid #f1f1f1;
      }

      .progress-circle-fill {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 15px solid var(--success-color);
        clip: rect(0, 75px, 150px, 0);
        transform: rotate(0deg);
      }

      .progress-circle-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2rem;
        font-weight: bold;
      }

      .feedback-card {
        background-color: #f9f9f9;
        border-left: 5px solid var(--primary-color);
        padding: 15px;
        margin-bottom: 15px;
        font-style: italic;
        color: #555;
        border-radius: 5px;
      }

      .top-improver {
        background-color: #f9f9f9;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        border-left: 5px solid var(--success-color);
      }

      .top-improver .name {
        font-weight: bold;
        color: #333;
      }

      .top-improver .improvement {
        font-weight: bold;
        color: var(--success-color);
      }
      
      .print-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        z-index: 1000;
        transition: all 0.3s ease;
      }
      
      .print-btn:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
      }
      
      .print-btn i {
        font-size: 24px;
      }
      
      @media print {
        .no-print {
          display: none !important;
        }
        
        body {
          padding: 0;
          background-color: white;
        }
        
        .content-box {
          box-shadow: none;
          margin: 0;
          padding: 15px;
        }
        
        .card {
          break-inside: avoid;
        }
      }
      
      .chart-container {
        height: 300px;
      }

      #summaryTextarea {
        min-height: 200px;
        resize: vertical;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark no-print">
      <a class="navbar-brand" href="#">
        <img
          src="/static/image_2024-02-07_191338051.png"
          width="40"
          height="40"
          class="d-inline-block align-top"
          alt="Logo"
        />
        <span>มหาวิทยาลัยเทคโนโลยีราชมงคลอีสาน<br />วิทยาเขตขอนแก่น</span>
      </a>
      <button
        class="navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbarNav"
        aria-controls="navbarNav"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('teacher_home') }}"
              ><i class="fas fa-home"></i> หน้าหลัก</a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link" href="add_project"
              ><i class="fas fa-plus"></i> เพิ่มโครงการ</a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('teacher_projects') }}"
              ><i class="fas fa-tasks"></i> จัดการโครงการ</a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('project_history') }}"
              ><i class="fas fa-history"></i> ประวัติโครงการ</a
            >
          </li>
          {% if g.user %}
          <li class="nav-item">
            <a
              class="nav-link"
              href="#"
              data-toggle="modal"
              data-target="#userInfoModal"
            >
              <i class="fas fa-user"></i> {{ g.user.name }}
            </a>
          </li>
          {% endif %}
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('logout') }}"
              ><i class="fas fa-sign-out-alt"></i> ออกจากระบบ</a
            >
          </li>
        </ul>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="content-box">
        <h2 class="text-center mb-4">
          <i class="fas fa-chart-line mr-2"></i>สรุปผลการดำเนินโครงการ
        </h2>
        
        <div class="text-center mb-4">
          <button onclick="window.history.back()" class="btn btn-secondary mr-2 no-print">
            <i class="fas fa-arrow-left"></i> กลับไปหน้าที่แล้ว
          </button>
          <button onclick="window.print()" class="btn btn-primary mr-2 no-print">
            <i class="fas fa-print"></i> พิมพ์รายงาน
          </button>
          {% if g.user and g.user.type == 'teacher' %}
          <button type="button" class="btn btn-success mr-2 no-print" data-toggle="modal" data-target="#saveReportModal">
            <i class="fas fa-save"></i> บันทึกสรุปรายงาน
          </button>
          {% endif %}
          {% if g.user and g.user.type == 'admin' %}
          <a href="{{ url_for('download_summary_pdf', project_id=project.project_id) }}" class="btn btn-info no-print">
            <i class="fas fa-file-pdf"></i> ดาวน์โหลด PDF
          </a>
          {% endif %}
        </div>

        <!-- ข้อมูลโครงการ -->
        <div class="mb-5">
          <h3 class="section-title"><i class="fas fa-info-circle mr-2"></i>ข้อมูลโครงการ</h3>
          
          <div class="row">
            <div class="col-md-8">
              <div class="card mb-3">
                <div class="card-body">
                  <h4 class="card-title text-primary">{{ project.project_name }}</h4>
                  <div class="row">
                    <div class="col-md-6">
                      <p><strong>ผู้รับผิดชอบโครงการ:</strong> {{ project.teacher_name }}</p>
                      <p><strong>สาขาวิชา:</strong> {{ project.branch_name }}</p>
                      <p><strong>งบประมาณ:</strong> {{ "{:,.2f}".format(project.project_budget) }} บาท</p>
                      <p><strong>สถานที่จัด:</strong> {{ project.project_address }}</p>
                    </div>
                    <div class="col-md-6">
                      <p><strong>ประเภทงบประมาณ:</strong> {{ project.project_budgettype }}</p>
                      <p><strong>ปีงบประมาณ:</strong> {{ project.project_year }}</p>
                      <p><strong>ระยะเวลา:</strong> {{ project.project_dotime.strftime('%d/%m/%Y') }} - {{ project.project_endtime.strftime('%d/%m/%Y') }}</p>
                      <p><strong>จำนวนผู้เข้าร่วมเป้าหมาย:</strong> {{ project.project_target }} คน</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-4">
              <div class="card h-100">
                <div class="card-body text-center">
                  <h5 class="card-title">ผลการดำเนินงาน</h5>
                  <div class="mt-3 mb-3">
                    <span class="status-badge 
                      {% if project_success.score >= 90 %}status-excellent
                      {% elif project_success.score >= 80 %}status-verygood
                      {% elif project_success.score >= 70 %}status-good
                      {% elif project_success.score >= 60 %}status-fair
                      {% elif project_success.score >= 50 %}status-poor
                      {% else %}status-improvement{% endif %}">
                      {{ project_success.level }}
                    </span>
                  </div>
                  <h3>{{ project_success.score }}%</h3>
                  <p class="mb-0">
                    {% if project.project_close_date %}
                      วันที่เสร็จสิ้น: {{ project.project_close_date.strftime('%d/%m/%Y') }}
                    {% endif %}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- สรุปการเข้าร่วม -->
        <div class="mb-5">
          <h3 class="section-title"><i class="fas fa-users mr-2"></i>การเข้าร่วมโครงการ</h3>
          
          <div class="row">
            <div class="col-md-4 mb-4">
              <div class="card info-card primary">
                <div class="card-header">
                  <i class="fas fa-users mr-2"></i>ผู้เข้าร่วมโครงการ
                </div>
                <div class="card-body">
                  <div class="text-center">
                    <h1>{{ participant_count }}</h1>
                    <p>จากเป้าหมาย {{ project.project_target }} คน</p>
                    <div class="progress">
                      <div class="progress-bar bg-success" role="progressbar" 
                           style="width: {{ (participant_count / project.project_target * 100) if project.project_target > 0 else 0 }}%" 
                           aria-valuenow="{{ participant_count }}" aria-valuemin="0" aria-valuemax="{{ project.project_target }}">
                        {{ "{:.1f}".format(participant_count / project.project_target * 100) if project.project_target > 0 else 0 }}%
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
           
            
            <div class="col-md-4 mb-4">
              <div class="card info-card success">
                <div class="card-header">
                  <i class="fas fa-star mr-2"></i>ความพึงพอใจ
                </div>
                <div class="card-body">
                  <div class="text-center">
                    <h1>{{ "{:.2f}".format(evaluation.average_score) }}</h1>
                    <p>คะแนนเฉลี่ย (จาก 5 คะแนน)</p>
                    <div class="progress">
                      <div class="progress-bar bg-warning" role="progressbar" 
                           style="width: {{ evaluation.average_score / 5 * 100 }}%" 
                           aria-valuenow="{{ evaluation.average_score }}" aria-valuemin="0" aria-valuemax="5">
                        {{ "{:.1f}".format(evaluation.average_score / 5 * 100) }}%
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        
            
           
          
        <!-- ผลประเมินความพึงพอใจ -->
        <div class="mb-5">
          <h3 class="section-title"><i class="fas fa-smile mr-2"></i>ผลการประเมินความพึงพอใจ</h3>
          
          <div class="row">
            <div class="col-md-6 mb-4">
              <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                  <i class="fas fa-star mr-2"></i>สรุปคะแนนความพึงพอใจ
                </div>
                <div class="card-body">
                  <div class="text-center mb-4">
                    <div class="progress-circle">
                      <div class="progress-circle-bg"></div>
                      <div class="progress-circle-fill" id="satisfactionProgress"></div>
                      <div class="progress-circle-value">{{ "{:.1f}".format(evaluation.average_score) }}/5</div>
                    </div>
                    <h5>ผู้ประเมิน {{ evaluation.total_evaluations }} คน</h5>
                  </div>
                  
                  <div class="row">
                    <div class="col-6">
                      <div class="text-center">
                        <h6>คะแนนต่ำสุด</h6>
                        <div class="display-4">{{ "{:.1f}".format(evaluation.min_score) }}</div>
                      </div>
                    </div>
                    <div class="col-6">
                      <div class="text-center">
                        <h6>คะแนนสูงสุด</h6>
                        <div class="display-4">{{ "{:.1f}".format(evaluation.max_score) }}</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-6 mb-4">
              <div class="card h-100">
                <div class="card-header bg-info text-white">
                  <i class="fas fa-comment mr-2"></i>ความคิดเห็นจากผู้เข้าร่วม
                </div>
                <div class="card-body">
                  {% if evaluation_comments %}
                    {% for comment in evaluation_comments %}
                      <div class="feedback-card">
                        <i class="fas fa-quote-left mr-2"></i>{{ comment }}
                      </div>
                    {% endfor %}
                  {% else %}
                    <div class="text-center mt-3">
                      <p>ไม่มีความคิดเห็นจากผู้เข้าร่วม</p>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- สรุปผล -->
        <div class="mb-3">
          <h3 class="section-title"><i class="fas fa-check-circle mr-2"></i>สรุปผลการดำเนินโครงการ</h3>
          
          <div class="card">
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <h5>ผลการดำเนินงาน</h5>
                  <p>จำนวนผู้เข้าร่วม: {{ participant_count }} คน ({{ "{:.1f}".format(participant_count / project.project_target * 100) if project.project_target > 0 else 0 }}% ของเป้าหมาย)</p>
                  <p>ความพึงพอใจเฉลี่ย: {{ "{:.2f}".format(evaluation.average_score) }}/5 คะแนน</p>
                  
                </div>
                <div class="col-md-6">
                  <h5>ประสิทธิผลโครงการ</h5>
                  <p>ประสิทธิผลรวม: {{ project_success.score }}% ({{ project_success.level }})</p>
                  <p>
                    การดำเนินโครงการครั้งนี้บรรลุวัตถุประสงค์
                    {% if project_success.score >= 80 %}
                      อยู่ในระดับดีมาก ประสบความสำเร็จตามเป้าหมายที่ตั้งไว้
                    {% elif project_success.score >= 70 %}
                      อยู่ในระดับดี ส่วนใหญ่บรรลุตามเป้าหมายที่ตั้งไว้
                    {% elif project_success.score >= 60 %}
                      อยู่ในระดับค่อนข้างดี บรรลุตามเป้าหมายหลักที่สำคัญ
                    {% elif project_success.score >= 50 %}
                      อยู่ในระดับพอใช้ บรรลุตามเป้าหมายได้บางส่วน
                    {% else %}
                      อยู่ในระดับที่ควรปรับปรุง ยังไม่บรรลุตามเป้าหมายที่ตั้งไว้
                    {% endif %}
                  </p>
                </div>
              </div>
              {% if project.summary_text %}
              <div class="row mt-4">
                <div class="col-12">
                  <h5>ข้อความสรุปผลการดำเนินโครงการ</h5>
                  <div class="p-3 bg-light rounded">
                    <p>{{ project.summary_text|nl2br }}</p>
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="print-btn no-print" onclick="window.print()">
      <i class="fas fa-print"></i>
    </div>

    <!-- Modal สำหรับบันทึกสรุปรายงาน -->
    <div class="modal fade" id="saveReportModal" tabindex="-1" role="dialog" aria-labelledby="saveReportModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="saveReportModalLabel">บันทึกสรุปรายงานโครงการ</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <form action="{{ url_for('save_project_summary', project_id=project.project_id) }}" method="post">
            <div class="modal-body">
              <div class="form-group">
                <label for="summaryTextarea">ข้อความสรุปผลการดำเนินโครงการ</label>
                <textarea class="form-control" id="summaryTextarea" name="summary_text" rows="8">{{ project.summary_text or '' }}</textarea>
                <small class="form-text text-muted">กรุณาระบุสรุปผลการดำเนินโครงการ ปัญหาอุปสรรค และข้อเสนอแนะอื่นๆ</small>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">ยกเลิก</button>
              <button type="submit" class="btn btn-primary">บันทึกสรุปรายงาน</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- User Info Modal -->
    {% if g.user %}
    <div
      class="modal fade"
      id="userInfoModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="userInfoModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="userInfoModalLabel">ข้อมูลผู้ใช้</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p><strong>ชื่อ:</strong> {{ g.user.name }}</p>
            <p><strong>อีเมล:</strong> {{ g.user.email or 'ไม่มีข้อมูล' }}</p>
            {% if g.user.type == 'teacher' %}
            <p>
              <strong>เบอร์โทรศัพท์:</strong> {{ g.user.phone or 'ไม่มีข้อมูล'
              }}
            </p>
            {% endif %}
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              ปิด
            </button>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script>
      $(document).ready(function() {
        // ตั้งค่า Progress Circle
        const satisfactionScore = {{ evaluation.average_score }};
        const satisfactionPercent = (satisfactionScore / 5) * 100;
        const progressCircle = document.getElementById('satisfactionProgress');
        
        if (satisfactionPercent <= 50) {
          progressCircle.style.clipPath = `polygon(50% 50%, 50% 0%, ${satisfactionPercent}% 0%)`;
        } else {
          progressCircle.style.clipPath = 'polygon(50% 50%, 50% 0%, 100% 0%, 100% 100%, 0% 100%, 0% 0%, 50% 0%)';
          progressCircle.style.clip = 'auto';
        }
        progressCircle.style.transform = `rotate(${satisfactionPercent * 3.6}deg)`;
        
        // Test Score Chart
        const testScoreChart = new Chart(
          document.getElementById('testScoreChart'),
          {
            type: 'bar',
            data: {
              labels: ['คะแนนก่อนเข้าร่วม', 'คะแนนหลังเข้าร่วม'],
              datasets: [{
                label: 'คะแนนเฉลี่ย',
                data: [{{ test.avg_pre_score }}, {{ test.avg_post_score }}],
                backgroundColor: [
                  'rgba(255, 159, 64, 0.8)',
                  'rgba(54, 162, 235, 0.8)'
                ],
                borderColor: [
                  'rgba(255, 159, 64, 1)',
                  'rgba(54, 162, 235, 1)'
                ],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100
                }
              },
              plugins: {
                title: {
                  display: true,
                  text: 'เปรียบเทียบคะแนนเฉลี่ยก่อนและหลังเข้าร่วมโครงการ'
                }
              }
            }
          }
        );
      });
    </script>
  </body>
</html>